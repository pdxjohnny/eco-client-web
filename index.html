<!DOCTYPE html>
<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properities -->
  <title>Map</title>
  <link rel="stylesheet" type="text/css" href="bower_components/semantic/dist/semantic.min.css">

</head>
<body>


  <div class="pusher">
    <div class="ui inverted vertical masthead center aligned segment">

      <div class="ui container">
        <div class="ui large secondary inverted pointing menu">
          <a class="active item" href="index.html">
            Map
          </a>
          <a class="item"  id="addThing" href="#">
            Add Somthing  <i class="right arrow icon"></i>
          </a>
        </div>
      </div>

    </div>
  </div>

  <div id="map" data-tap-disabled="true"></div>

  <div id="popup"  class="ui page modal">
    <i class="close icon"></i>
    <div  id="name" class="header">
    </div>
    <div class="image content">
      <div class="ui medium image">
        <img src="assets/images/no-image.png">
      </div>
      <div class="description">
        <!-- <div id="name" class="ui header"></div> -->
        <p id="description"></p>
      </div>
    </div>
    <div class="actions">
      <div id="cancel"  class="ui red deny button">
        Cancel
      </div>
      <div id="action" class="ui positive right labeled icon button">
        <i class="checkmark icon"></i>
        <p id="actionText">
        </p>
      </div>
    </div>
  </div>

  <script>
var addMarker = function (map, thing) {
  if (typeof thing.name === 'undefined' || thing.name.length < 1) {
    thing.name = "Name"
  }
  if (typeof thing.description === 'undefined' || thing.description.length < 1) {
    thing.description = "Description"
  }
  var position = {};
  position.lng = Number(thing.longitude);
  position.lat = Number(thing.latitude);

  var marker = new google.maps.Marker({
    position: position,
    map: map,
    title: thing.name,
    draggable: false
  });

  var startEditing = function (event) {
    console.log('Now editing', marker.draggable);
    $('#name').attr('contenteditable', true);
    $('#description').attr('contenteditable', true);
    marker.setDraggable(true);
    google.maps.event.clearListeners(marker, 'dragstart');
    marker.addListener('dragstart', function (event) {
      console.log('Dragging marker:', marker.getPosition());

    });
    marker.addListener('dragend', function (event) {
      console.log('Done dragging marker:', marker.getPosition());
    });
  };

  var endEditing = function (event) {
    console.log('endEditing');
    $('#name').attr('contenteditable', false);
    $('#description').attr('contenteditable', false);
    marker.setDraggable(false);
    google.maps.event.clearListeners(marker, 'dragstart');
    google.maps.event.clearListeners(marker, 'dragend');
  };

  var saveEditing = function (event) {
    console.log('saveEditing');
    endEditing();
    thing.name = $('#name').text();
    thing.description = $('#description').text();
    thing.longitude = marker.getPosition().lng();
    thing.latitude = marker.getPosition().lat();
    console.log('About to save thing:', thing);
    API.SaveThing(thing['_id'] || thing['id'], thing, function (data) {
      console.log('Success saving thing:', data);
      if (data.UpsertedId !== null) {
        thing['_id'] = data.UpsertedId;
        console.log(thing['_id']);
      }
    },
    function (err) {
      console.log('ERROR while saving edited thing:', err);
    });
  };

  var interact = function(event) {
    console.log('Interaction', marker.draggable);
    map.panTo(marker.getPosition());
    $('#popup').modal('show');
    $('#action').unbind();
    $('#cancel').unbind();
    $('#cancel').on('mousedown', endEditing);
    if (marker.draggable === false) {
      $('#actionText').text('Edit');
      $('#cancel').hide();
      $('#action').on('mousedown', startEditing);
    } else {
      $('#actionText').text('Save Edits');
      $('#cancel').show();
      $('#action').on('mousedown', saveEditing);
    }
    for (var prop in thing) {
      if (thing.hasOwnProperty(prop)) {
        $('#'+prop).text(thing[prop]);
      }
    }
  };
  marker.addListener('click', interact);
  marker.interact = interact;
  marker.startEditing = startEditing;
  marker.endEditing = endEditing;
  marker.saveEditing = saveEditing;
  return marker;
};

  function initMap() {
    var map;
    $('#addThing').on('mousedown', function (event) {

      API.GetLocation(function (data) {
        console.log('Got location', data);
        var newThing = {
          longitude: data.coords.longitude,
          latitude: data.coords.latitude,
        }
        var marker = addMarker(map, newThing);
        marker.startEditing();
        marker.interact();
      });
    });

    var center = {};
    API.GetLocation(function (data) {
      console.log('Got location', data);
      center.lng = data.coords.longitude;
      center.lat = data.coords.latitude;

      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 10,
        center: center
      });

      var options = {
        longitude: center.lng,
         latitude: center.lat,
         radius: 10 * 5000
      };
      API.GetNear(options, function (data) {
        // console.log('Got things', data);
        if (data['rows'] === null) {
          console.log('Rows is null, theres nothing here');
          return;
        }

        for (var i = 0; i < data['rows'].length; i++) {
          var thing = data['rows'][i];
          // console.log('Got thing', thing);
          addMarker(map, thing);
        }
      },
      function (data) {
        console.error('ERROR getting near', data);
      }
    );
    },
    function (data) {
      console.error('ERROR getting location', data);
    }
  );
}

  </script>

<style type="text/css">
html, body {
  height: 100%;
}
body {
  display: flex;
  flex-flow: column;
  height: 100%;
}
#map {
  flex: 1 1 auto;
}
</style>

<script src="bower_components/jquery/dist/jquery.min.js" charset="utf-8"></script>
<script src="bower_components/semantic/dist/semantic.min.js" charset="utf-8"></script>

<script src="js/global.js" charset="utf-8"></script>
<script src="js/api.js" charset="utf-8"></script>
<script src="js/link.js" charset="utf-8"></script>
<script src="js/result.js" charset="utf-8"></script>
<script src="js/item.js" charset="utf-8"></script>
<script src="js/form.js" charset="utf-8"></script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAF3-mhc-PArqMLukKDVVX_ch9ZU7D4VhU&callback=initMap"></script>

</body>
</html>
